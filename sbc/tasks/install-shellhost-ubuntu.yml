---
 - name: get service facts
   service_facts:
   
 - name: stop shell if installed
   service:
     name: shell
     state: stopped
   when: ansible_facts.services["shell.service"] is defined

 - git:
     repo: https://github.com/practable/relay.git
     dest: /home/pi/sources/relay
     update: yes

 - name: shell build
   command: /snap/bin/go build
   args:
     chdir: /home/ubuntu/sources/relay/cmd/shell 

 - name: shell install
   command: cp shell /usr/local/bin/shell-relay
   register: task_result
   until: task_result.rc == 0
   retries: 10
   delay: 5
   ignore_errors: yes 
   args:
     chdir: /home/ubuntu/sources/relay/cmd/shell
     

 - name: copy customised shell service file 
   copy: src=../autogenerated/shellhost.service.{{ practable_label }} dest=/etc/systemd/system/shellhost.service
   
 - name: copy customised shell2 service file 
   copy: src=../autogenerated/shellhost2.service.{{ practable_label }} dest=/etc/systemd/system/shellhost2.service
   
 - name: start shell host
   service:
     name: shellhost
     state: started
     enabled: true
     
 - name: start shell2 host
   service:
     name: shellhost2
     state: started
     enabled: true
     
 - name: get service facts
   service_facts:
      
 - name: check shellhost service installed
   fail:
     msg: "shell service is not installed"
   when: ansible_facts.services["shellhost.service"] is not defined
